#!/bin/bash

#===============================================================================
# Overview
#===============================================================================
# This script generates Figure 7 from the GRT paper.
# It executes `mutation.sh` multiple times, varying:
#   - Subject programs (SUBJECT_PROGRAMS)
#   - Feature variants (FEATURES)
#
#===============================================================================
# Output
#===============================================================================
# `results/fig7-info.csv`:   Contains raw data collected from `mutation.sh`. This file is
#                            appended to by each experimental run.
# `results/fig7-report.pdf`: Final report containing Figure 7, generated from
#                            `results/info.csv`.
#
#===============================================================================
# Important Notes
#===============================================================================
# Running this script will overwrite any previous reports generated by this script
# (results/fig7-report.pdf and results/fig7-info.csv).
# If you wish to preserve a previous report, **make sure to download or back it up before running
# this script again**.
#
#------------------------------------------------------------------------------
# Usage (run in experiment-scripts/ directory):
#------------------------------------------------------------------------------
#   ./mutation-fig7.sh
#------------------------------------------------------------------------------
# Prerequisites:
#------------------------------------------------------------------------------
# See file `mutation-prerequisites.md`.
#
#===============================================================================

SCRIPTDIR="$(cd "$(dirname "$0")" > /dev/null 2>&1 && pwd -P)"
cd "$SCRIPTDIR" || exit 2
MUTATION_DIR="$(realpath ../)"

PYTHON_EXECUTABLE=$(command -v python3 2> /dev/null || command -v python 2> /dev/null)
if [ -z "$PYTHON_EXECUTABLE" ]; then
  echo "Error: Python is not installed." >&2
  exit 1
fi

pip install pandas
pip install matplotlib
pip install seaborn

# Clean up previous run artifacts
rm -rf $MUTATION_DIR/build/bin/*
rm -rf $MUTATION_DIR/build/test/*
rm -rf $MUTATION_DIR/build/lib/*
rm -f $MUTATION_DIR/results/fig7-report.pdf
rm -f $MUTATION_DIR/results/fig7-info.csv

#===============================================================================
# The GRT paper's parameters are as follows:
NUM_LOOP=10
TOTAL_SECONDS=(600)
SUBJECT_PROGRAMS=(
  "a4j-1.0b"
  "asm-5.0.1"
  "bcel-5.2"
  "ClassViewer-5.0.5b"
  "commons-cli-1.2"
  "commons-codec-1.9"
  "commons-collections4-4.0"
  "commons-compress-1.8"
  "commons-lang3-3.0"
  "commons-math3-3.2"
  "commons-primitives-1.0"
  "dcParseArgs-10.2008"
  "easymock-3.2"
  "fixsuite-r48"
  "guava-16.0.1"
  "hamcrest-core-1.3"
  "javassist-3.19"
  "javax.mail-1.5.1"
  "jaxen-1.1.6"
  "jcommander-1.35"
  "jdom-1.0"
  "joda-time-2.3"
  "JSAP-2.1"
  "jvc-1.1"
  "nekomud-r16"
  "pmd-core-5.2.2"
  "sat4j-core-2.3.5"
  "shiro-core-1.2.3"
  "slf4j-api-1.7.12"
  "tiny-sql-2.26"
)
FEATURES=(CONSTANT_MINING GRT_FUZZING ELEPHANT_BRAIN DETECTIVE ORIENTEERING BLOODHOUND GRT)

# Temporary parameters for testing that override the defaults, since we haven't
# implemented all GRT features. See mutation.sh for a list of different features
# you can specify.
NUM_LOOP=1
TOTAL_SECONDS=(10)
SUBJECT_PROGRAMS=(
  "dcParseArgs-10.2008"
  "slf4j-api-1.7.12"
)
FEATURES=(
  "BLOODHOUND"
  "ORIENTEERING"
)

NUM_CORES=$(($(nproc) - 4))
echo "Running $NUM_CORES concurrent processes"

#===============================================================================
# Task Generation & Execution
#===============================================================================
TASKS=()
for tseconds in "${TOTAL_SECONDS[@]}"; do
  for program in "${SUBJECT_PROGRAMS[@]}"; do
    for feature in "${FEATURES[@]}"; do
      TASKS+=("$MUTATION_DIR $tseconds $program $feature $NUM_LOOP")
    done
  done
done

# Export function for parallel execution
# Each run's output is redirected to mutation_output.txt within its respective results directory.
run_task() {
  mutation_dir=$1
  tseconds=$2
  program=$3
  feature=$4
  num_loop=$5
  echo "Running: (cd $mutation_dir && ./mutation.sh -c $tseconds -f $feature -r -i fig7 -n $num_loop $program)"
  (cd "$mutation_dir" && ./mutation.sh -t "$tseconds" -f "$feature" -r -i "fig7" -n "$num_loop" "$program")
}

export -f run_task

# Run tasks in parallel.
printf "%s\n" "${TASKS[@]}" | parallel -j $NUM_CORES --colsep ' ' run_task

#===============================================================================
# Figure Generation (Fig. 7)
#===============================================================================

# Outputs figures to result/fig7-report.pdf
"$PYTHON_EXECUTABLE" "$MUTATION_DIR"/experiment-scripts/generate-grt-figures.py fig7
